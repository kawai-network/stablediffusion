name: Integration Test - Image Generation

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      model_url:
        description: 'URL to download test model (optional)'
        required: false
        default: ''
      test_timeout:
        description: 'Test timeout in minutes'
        required: false
        default: '30'

env:
  MODEL_PATH: models/v1-5-pruned-emaonly.safetensors

jobs:
  integration-test:
    name: Image Generation Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Build package
        run: go build -v ./...

      - name: Cache stable-diffusion.cpp library
        id: cache-sd-lib
        uses: actions/cache@v4
        with:
          path: native
          key: sd-lib-${{ runner.os }}-${{ runner.arch }}-4ff2c8c

      - name: Download stable-diffusion.cpp (Linux)
        if: runner.os == 'Linux' && steps.cache-sd-lib.outputs.cache-hit != 'true'
        run: |
          echo "Downloading stable-diffusion.cpp for Linux..."
          mkdir -p native
          wget -q https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-Linux-Ubuntu-24.04-x86_64.zip
          unzip -q sd-master-4ff2c8c-bin-Linux-Ubuntu-24.04-x86_64.zip
          cp bin/libstable-diffusion.so native/ || cp libstable-diffusion.so native/
          ls -la native/
          
      - name: Download stable-diffusion.cpp (macOS)
        if: runner.os == 'macOS' && steps.cache-sd-lib.outputs.cache-hit != 'true'
        run: |
          echo "Downloading stable-diffusion.cpp for macOS..."
          mkdir -p native
          wget -q https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-Darwin-macOS-15.7.2-arm64.zip
          unzip -q sd-master-4ff2c8c-bin-Darwin-macOS-15.7.2-arm64.zip
          cp bin/libstable-diffusion.dylib native/ || cp libstable-diffusion.dylib native/
          ls -la native/
          
      - name: Download stable-diffusion.cpp (Windows)
        if: runner.os == 'Windows' && steps.cache-sd-lib.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Downloading stable-diffusion.cpp for Windows..."
          mkdir -p native
          curl -L -o sd-windows.zip https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-win-avx2-x64.zip
          unzip -q sd-windows.zip
          cp bin/stable-diffusion.dll native/ || cp stable-diffusion.dll native/
          ls -la native/

      - name: Cache SD 1.5 Model
        id: cache-model
        uses: actions/cache@v4
        with:
          path: models/v1-5-pruned-emaonly.safetensors
          key: sd15-pruned-emaonly-v1
          restore-keys: |
            sd15-pruned-emaonly-

      - name: Download SD 1.5 Model
        if: steps.cache-model.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Downloading SD 1.5 pruned-emaonly safetensors (~4GB)..."
          mkdir -p models
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            curl -L --progress-bar -o models/v1-5-pruned-emaonly.safetensors "https://huggingface.co/stable-diffusion-v1-5/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.safetensors"
          else
            wget --progress=bar:force -O models/v1-5-pruned-emaonly.safetensors "https://huggingface.co/stable-diffusion-v1-5/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.safetensors"
          fi
          ls -lh models/

      - name: Verify Model
        shell: bash
        run: |
          ls -lh models/
          file models/v1-5-pruned-emaonly.safetensors || true

      - name: Run Integration Tests
        timeout-minutes: 30
        shell: bash
        run: |
          echo "Running integration tests..."
          ls -la native/ || true
          ls -la models/ || true
          echo ""
          echo "Running TestIntegration (library loading)..."
          go test -v -run TestIntegration -timeout 5m ./...
          echo ""
          echo "Running TestImageGeneration (actual image generation)..."
          go test -v -run TestImageGeneration -timeout 30m ./...

      - name: Test Summary
        if: always()
        run: |
          echo "Integration test completed on ${{ matrix.os }}"
