name: Integration Test - Video Generation

on:
  workflow_dispatch:
    inputs:
      model_url:
        description: "URL to download test video model (required, prefer GGUF)"
        required: true
      vae_url:
        description: "Optional URL for VAE when using safetensors video checkpoint"
        required: false
        default: ""
      hf_token:
        description: "Optional Hugging Face token for gated/private model URLs"
        required: false
        default: ""
      test_timeout:
        description: "Test timeout in minutes"
        required: false
        default: "30"

jobs:
  integration-test-video:
    name: Video Generation Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Build package
        run: go build -v ./...

      - name: Download stable-diffusion.cpp (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Downloading stable-diffusion.cpp for Linux..."
          mkdir -p native
          wget -q https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-Linux-Ubuntu-24.04-x86_64.zip
          unzip -q sd-master-4ff2c8c-bin-Linux-Ubuntu-24.04-x86_64.zip
          cp bin/libstable-diffusion.so native/ || cp libstable-diffusion.so native/
          ls -la native/

      - name: Download stable-diffusion.cpp (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Downloading stable-diffusion.cpp for macOS..."
          mkdir -p native
          wget -q https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-Darwin-macOS-15.7.2-arm64.zip
          unzip -q sd-master-4ff2c8c-bin-Darwin-macOS-15.7.2-arm64.zip
          cp bin/libstable-diffusion.dylib native/ || cp libstable-diffusion.dylib native/
          ls -la native/

      - name: Download stable-diffusion.cpp (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Downloading stable-diffusion.cpp for Windows..."
          mkdir -p native
          curl -L -o sd-windows.zip https://github.com/leejet/stable-diffusion.cpp/releases/download/master-453-4ff2c8c/sd-master-4ff2c8c-bin-win-avx2-x64.zip
          unzip -q sd-windows.zip
          cp bin/stable-diffusion.dll native/ || cp stable-diffusion.dll native/
          ls -la native/

      - name: Test Library Loading
        run: |
          echo "Testing library loading..."
          go test -v -run TestLibraryName ./...

      - name: Resolve Model URL
        shell: bash
        run: |
          MODEL_URL="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model_url || vars.VIDEO_MODEL_URL }}"
          if [[ -z "$MODEL_URL" ]]; then
            echo "::error::Model URL is required. Set workflow_dispatch input model_url or repository variable VIDEO_MODEL_URL."
            exit 1
          fi
          VAE_URL="${{ github.event.inputs.vae_url }}"
          # Auto-derive a valid VAE URL for known SVD XT 1.1 safetensors model.
          if [[ -z "$VAE_URL" && "$MODEL_URL" == *"vdo/stable-video-diffusion-img2vid-xt-1-1/resolve/main/svd_xt_1_1.safetensors"* ]]; then
            VAE_URL="https://huggingface.co/vdo/stable-video-diffusion-img2vid-xt-1-1/resolve/main/vae/diffusion_pytorch_model.safetensors"
          fi
          echo "MODEL_URL=$MODEL_URL" >> $GITHUB_ENV
          echo "VAE_URL=$VAE_URL" >> $GITHUB_ENV
          echo "Using model URL source: $MODEL_URL"
          if [[ -n "$VAE_URL" ]]; then
            echo "Using VAE URL source: $VAE_URL"
          fi

      - name: Download Test Model
        shell: bash
        run: |
          echo "Downloading custom test video model..."
          mkdir -p models
          MODEL_FILENAME="$(basename "${MODEL_URL%%\?*}")"
          if [[ -z "$MODEL_FILENAME" || "$MODEL_FILENAME" == "." || "$MODEL_FILENAME" == "/" ]]; then
            MODEL_FILENAME="test-video-model"
          fi
          MODEL_PATH="models/$MODEL_FILENAME"
          if [[ -n "${{ github.event.inputs.hf_token }}" ]]; then
            curl --fail --location --retry 3 \
              -H "Authorization: Bearer ${{ github.event.inputs.hf_token }}" \
              -o "$MODEL_PATH" "$MODEL_URL"
          else
            curl --fail --location --retry 3 \
              -o "$MODEL_PATH" "$MODEL_URL"
          fi
          ls -lh models/
          echo "VIDEO_MODEL_PATH=$MODEL_PATH" >> $GITHUB_ENV

      - name: Download Video VAE (optional)
        if: env.VAE_URL != ''
        shell: bash
        run: |
          echo "Downloading video VAE..."
          mkdir -p models
          VAE_FILENAME="$(basename "${VAE_URL%%\?*}")"
          if [[ -z "$VAE_FILENAME" || "$VAE_FILENAME" == "." || "$VAE_FILENAME" == "/" ]]; then
            VAE_FILENAME="test-video-vae"
          fi
          VAE_PATH="models/$VAE_FILENAME"
          if [[ -n "${{ github.event.inputs.hf_token }}" ]]; then
            curl --fail --location --retry 3 \
              -H "Authorization: Bearer ${{ github.event.inputs.hf_token }}" \
              -o "$VAE_PATH" "$VAE_URL"
          else
            curl --fail --location --retry 3 \
              -o "$VAE_PATH" "$VAE_URL"
          fi
          ls -lh models/
          echo "VIDEO_VAE_PATH=$VAE_PATH" >> $GITHUB_ENV

      - name: Run Video Integration Tests
        timeout-minutes: 30
        shell: bash
        run: |
          echo "Running video integration tests..."
          ls -la native/ || true
          echo "Running TestIntegration (library loading)..."
          go test -v -run TestIntegration -timeout 5m ./...
          echo ""
          echo "Running TestVideoGeneration (actual video generation)..."
          go test -v -run TestVideoGeneration -timeout ${{ github.event.inputs.test_timeout || 30 }}m ./...

      - name: Test Summary
        if: always()
        run: |
          echo "Video integration test completed on ${{ matrix.os }}"
